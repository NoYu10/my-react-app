(()=>{"use strict";({994:function(){var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const t=()=>e(void 0,void 0,void 0,function*(){try{const e=new Date,t=yield chrome.storage.local.get(["flexTime_startTime","flexTime_targetHours","flexTime_targetMinutes","flexTime_breakStart","flexTime_breakEnd","flexTime_overtimeHours","flexTime_overtimeMinutes","flexTime_shortageHours","flexTime_shortageMinutes","notificationsAllowed","notificationShown","earlyLeaveNotificationShown","lastCheckedDate"]),i=new Date,n=i.getFullYear(),r=`${n}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`;let{flexTime_startTime:a,flexTime_targetHours:o=6,flexTime_targetMinutes:s=0,flexTime_breakStart:c,flexTime_breakEnd:l,flexTime_overtimeHours:u="",flexTime_overtimeMinutes:m="",flexTime_shortageHours:f="",flexTime_shortageMinutes:h="",notificationsAllowed:d,notificationShown:g,earlyLeaveNotificationShown:p,lastCheckedDate:T}=t;if(void 0===T&&(T=r),T!==r&&(console.log(`Date changed from ${T} to ${r}. Resetting notification flags.`),yield chrome.storage.local.set({notificationShown:"false",earlyLeaveNotificationShown:"false",lastCheckedDate:r}),g="false",p="false"),"true"!==d||!a)return;const N=/^\d{2}:\d{2}$/,w=()=>{const t=Number(o)+Number(s)/60>=6?.75:0;if(c&&N.test(c)&&l&&N.test(l)){const e=new Date,[i,n]=c.split(":");if(isNaN(parseInt(i))||isNaN(parseInt(n)))return{required:t,actual:0};e.setHours(parseInt(i),parseInt(n),0,0);const r=new Date,[a,o]=l.split(":");if(isNaN(parseInt(a))||isNaN(parseInt(o)))return{required:t,actual:0};r.setHours(parseInt(a),parseInt(o),0,0);const s=(r.getTime()-e.getTime())/36e5;return{required:t,actual:Math.max(0,s)}}if(c&&N.test(c)&&!l){const i=new Date,[n,r]=c.split(":");if(isNaN(parseInt(n))||isNaN(parseInt(r)))return{required:t,actual:0};if(i.setHours(parseInt(n),parseInt(r),0,0),e>=i){const n=(e.getTime()-i.getTime())/36e5;return{required:t,actual:Math.max(0,n)}}}return{required:t,actual:0}},x=()=>{if(!a||!N.test(a))return"--:--";const e=new Date,[t,i]=a.split(":");if(isNaN(parseInt(t))||isNaN(parseInt(i)))return console.error("Invalid start time format:",a),"--:--";e.setHours(parseInt(t),parseInt(i),0,0);const n=w(),r=60*Number(o)+Number(s),c=60*n.actual;return new Date(e.getTime()+60*r*1e3+60*c*1e3).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",hour12:!1})},v=()=>{const e=60*Number(u)+Number(m)-(60*Number(f)+Number(h));return{balanceInMinutes:e,isOvertime:e>0,hours:Math.floor(Math.abs(e)/60),minutes:Math.abs(e)%60}},_=()=>{const e=v();if(!e.isOvertime||!a||!N.test(a))return null;const t=x();if("--:--"===t)return null;const[i,n]=t.split(":");if(isNaN(parseInt(i))||isNaN(parseInt(n)))return null;const r=new Date;return r.setHours(parseInt(i),parseInt(n),0,0),new Date(r.getTime()-60*e.balanceInMinutes*1e3).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",hour12:!1})},I=x(),b=_(),M=v();if("true"!==g&&"--:--"!==I){const[t,i]=I.split(":").map(Number),n=new Date(e);if(n.setHours(t,i,0,0),e>=n){let e="推奨退勤時間になりました！";M.isOvertime||0===M.balanceInMinutes||(e+=`\n今月は${M.hours>0?`${M.hours}時間`:""}${M.minutes}分不足しています。`),e+="\n（通知を完全に止めるには設定から通知をオフにしてください）",chrome.notifications.create("end-time-notification",{type:"basic",iconUrl:"icon128.png",title:"フレックスタイム管理",message:e,requireInteraction:!0}),yield chrome.storage.local.set({notificationShown:"true"})}}if("true"!==p&&b){const[t,i]=b.split(":").map(Number),n=new Date(e);n.setHours(t,i,0,0),e>=n&&(chrome.notifications.create("early-leave-notification",{type:"basic",iconUrl:"icon128.png",title:"フレックスタイム管理",message:`${M.hours>0?`${M.hours}時間`:""}${M.minutes}分早く帰れます！\n（通知を完全に止めるには設定から通知をオフにしてください）`,requireInteraction:!0}),yield chrome.storage.local.set({earlyLeaveNotificationShown:"true"}))}}catch(e){console.error("通知チェックエラー:",e)}}),i=()=>{chrome.alarms.clear("notificationCheck",e=>{const t=new Date,i=new Date(t.getTime());i.setMinutes(t.getMinutes()+1),i.setSeconds(0,0),chrome.alarms.create("notificationCheck",{when:i.getTime(),periodInMinutes:1})}),t()};chrome.alarms.onAlarm.addListener(e=>{"notificationCheck"===e.name&&t()}),chrome.storage.onChanged.addListener((t,i)=>e(void 0,void 0,void 0,function*(){"local"===i&&["flexTime_startTime","flexTime_targetHours","flexTime_targetMinutes","flexTime_breakStart","flexTime_breakEnd","flexTime_overtimeHours","flexTime_overtimeMinutes","flexTime_shortageHours","flexTime_shortageMinutes"].some(e=>e in t)&&(yield chrome.storage.local.set({notificationShown:"false",earlyLeaveNotificationShown:"false"}))})),chrome.runtime.onStartup.addListener(i),chrome.runtime.onInstalled.addListener(i),chrome.runtime.onMessage.addListener((e,t,n)=>{try{"startNotificationCheck"===e.action?(i(),n({success:!0,message:"Notification check started/reset"})):"ping"===e.action?n({success:!0,message:"Service Worker is alive"}):(console.warn("Unknown action received:",e.action),n({success:!1,error:"Unknown action"}))}catch(e){console.error("onMessage listener error:",e),n({success:!1,error:e.message||"Unknown error"})}return!0}),chrome.notifications.onClicked.addListener(e=>{chrome.action.openPopup()}),chrome.notifications.onButtonClicked.addListener((e,t)=>{})}})[994]()})();